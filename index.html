<!DOCTYPE html>
<html>
<head>
  <title>Wheel Inventory Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111827;
      color: white;
      padding: 20px;
      max-width: 650px;
      margin: auto;
    }
    h2 { text-align: center; }
    .card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #1f2937;
      padding: 15px;
      margin: 10px 0;
      border-radius: 12px;
    }
    .info { font-size: 16px; }
    .bigButton {
      font-size: 22px;
      padding: 14px 22px;
      border-radius: 10px;
      background: #3b82f6;
      border: none;
      color: white;
      cursor: pointer;
    }
    .bigButton:hover { background: #2563eb; }
    .total { text-align: center; margin-top: 20px; font-size: 18px; }
  </style>
</head>
<body>

<h2>Wheel Inventory Manager</h2>

<div id="itemsContainer"></div>

<div class="total">
  Total Spins: <span id="totalSpins">Loading...</span>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw5p_pamqz5ChVA_CxbVhHu1nXzG5S2cMRFDwfBNaMDJew9E9PGkfrrRBz-eMUjMvfRmQ/exec";

let data = {};
let history = [];

window.onload = loadData;

// ---------------- Load Data ----------------
function loadData() {
  fetch(WEB_APP_URL)
    .then(res => res.json())
    .then(res => {
      data = res;
      history = res.History || [];
      renderItems();
      updateDisplay();
    })
    .catch(err => {
      document.body.innerHTML = "<h2>Error loading data. Check Web App URL and deployment.</h2>";
      console.error(err);
    });
}

// ---------------- Render Items ----------------
function renderItems() {
  const container = document.getElementById("itemsContainer");
  container.innerHTML = "";

  for (let item in data) {
    if (item === "Total Spinned") continue;

    const div = document.createElement("div");
    div.className = "card";

    div.innerHTML = `
      <div class="info">
        <strong>${item}</strong><br>
        <span id="${safeId(item)}"></span>
      </div>
      <button class="bigButton" onclick="handleClick('${item}')">
        ${item === "Donation" ? "+1" : "-1"}
      </button>
    `;
    container.appendChild(div);
  }

  // Undo button
  const undoDiv = document.createElement("div");
  undoDiv.style.textAlign = "center";
  undoDiv.style.marginTop = "20px";
  undoDiv.innerHTML = `<button class="bigButton" onclick="undo()">Undo Last Action</button>`;
  container.appendChild(undoDiv);
}

// ---------------- Button Handler ----------------
function handleClick(item) {
  const snapshot = JSON.parse(JSON.stringify(data)); // snapshot before action

  if (item === "Donation") {
    data[item].inventory++;
    data["Total Spinned"]++;
    history.push({type:"donation", snapshot});
  } else {
    if (data[item].inventory <= 0) return;

    data[item].inventory--;
    data["Total Spinned"]++;
    history.push({type:"subtract", item, snapshot});

    if (data[item].inventory === 0) redistributeSectors(item);
  }

  updateDisplay();
  sync();
}

// ---------------- Undo ----------------
function undo() {
  if (history.length === 0) { alert("No actions to undo"); return; }
  const last = history.pop();
  data = last.snapshot;
  updateDisplay();
  sync();
}

// ---------------- Redistribution ----------------
function redistributeSectors(outItem) {
  let removed = data[outItem].sectors;
  if (removed === 0) return;

  data[outItem].sectors = 0;
  let remaining = removed;
  let instructions = [];

  // Rule 1: Donation gets 1 if < 7
  if (data["Donation"].sectors < 7 && remaining > 0) {
    data["Donation"].sectors++;
    instructions.push("Add 1 Donation sector");
    remaining--;
  }

  // Rule 2: Distribute remaining
  while (remaining > 0) {
    let available = Object.keys(data)
      .filter(k => k !== outItem && k !== "Total Spinned")
      .filter(k => data[k].inventory > 0);

    if (available.length === 0) break;
    available.sort((a,b) => data[b].inventory - data[a].inventory);

    for (let item of available) {
      if (remaining <= 0) break;
      data[item].sectors++;
      instructions.push("Add 1 " + item + " sector");
      remaining--;
    }

    if (available.length === 1 && remaining > 0) {
      data[available[0]].sectors += remaining;
      instructions.push("Add " + remaining + " " + available[0] + " sector(s)");
      remaining = 0;
    }
  }

  showPopup(outItem, removed, instructions);
}

// ---------------- Popup ----------------
function showPopup(item, removed, instructions) {
  let msg = `âš  ${item} is OUT OF STOCK.\n\nRemove ${removed} sector(s).\n\nReplace with:\n\n`;
  instructions.forEach(i => msg += "- " + i + "\n");
  msg += "\nUpdate the physical wheel accordingly.";
  alert(msg);
}

// ---------------- Update Display ----------------
function updateDisplay() {
  for (let item in data) {
    if (item === "Total Spinned") continue;
    document.getElementById(safeId(item)).innerText =
      "Inventory: " + data[item].inventory + " | Sectors: " + data[item].sectors;
  }
  document.getElementById("totalSpins").innerText = data["Total Spinned"];
}

// ---------------- Sync with Sheet ----------------
function sync() {
  data.History = history;
  fetch(WEB_APP_URL, {
    method: "POST",
    body: JSON.stringify(data)
  });
}

// ---------------- Utils ----------------
function safeId(text) { return text.replace(/\s/g,''); }
</script>

</body>
</html>
