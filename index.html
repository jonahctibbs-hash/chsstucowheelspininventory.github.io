<!DOCTYPE html>
<html>
<head>
  <title>Wheel Inventory Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial; background: #111827; color: white; padding:20px; max-width:700px; margin:auto;}
    h2,h3{text-align:center;}
    .card{
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:#1f2937;
      padding:15px;
      margin:10px 0;
      border-radius:12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      transition:0.2s;
    }
    .card.outOfStock{
      background:#b91c1c; /* red for out of stock */
      color:white;
    }
    .info{font-size:16px;}
    .bigButton{
      font-size:20px;
      padding:12px 20px;
      border-radius:10px;
      background:#3b82f6;
      border:none;
      color:white;
      cursor:pointer;
      transition:0.2s;
    }
    .bigButton:hover{background:#2563eb;}
    .total{text-align:center;margin-top:20px;font-size:18px;}
    
    /* History Container */
    #historyContainer{
      background:#1f2937; 
      padding:15px; 
      border-radius:12px; 
      max-height:300px; 
      overflow-y:auto; 
      margin-top:10px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }

    /* Individual History Entries */
    .historyEntry{
      margin-bottom:6px;
      font-size:16px;
      padding:8px 10px;
      border-radius:6px;
      background: #374151;
      color:#facc15;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.3);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .historyEntry span.date{ 
      color:#e5e7eb; /* high-contrast light gray */
      font-size:14px; 
      margin-left:10px;
    }
    .historyEntry.recent{
      background:#f59e0b;
      color:#111827;
      font-weight:bold;
    }
    .historyEntry.collapsed{
      display:none;
    }
    #toggleHistoryButton{
      display:block;
      margin:10px auto;
      background:#10b981;
      border:none;
      color:white;
      padding:8px 16px;
      border-radius:8px;
      cursor:pointer;
      font-size:16px;
      transition:0.2s;
    }
    #toggleHistoryButton:hover{background:#059669;}
  </style>
</head>
<body>

<h2>Wheel Inventory Manager</h2>

<div id="itemsContainer"></div>

<div class="total">
  Total Spins: <span id="totalSpins">Loading...</span>
</div>

<h3>Action History</h3>
<div id="historyContainer"></div>
<button id="toggleHistoryButton" onclick="toggleHistory()">Show Older History</button>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwEvnB_YFLH03HJgBM-4EYwCLGnu2g15EyOrPcR844BFBhAVW7aUKuhY-aTDGfH_1AmVQ/exec"; // replace with your /exec URL

let data = {};
let history = [];
let originalData = {};
const MAX_HISTORY_DISPLAY = 5;
let historyExpanded = false;

// ---------------- Debounced Sync ----------------
let syncTimeout = null;
function sync(){
  if(syncTimeout) clearTimeout(syncTimeout);
  syncTimeout = setTimeout(() => {
    data.History = history;
    fetch(WEB_APP_URL,{
      method:"POST",
      body:JSON.stringify(data)
    }).catch(err => console.error("Sync failed:", err));
  }, 5000); // 5-second delay
}

// ---------------- Utility ----------------
function safeId(text){ return text.replace(/\s/g,''); }
function timestamp(){ return new Date().toLocaleString(); }

// ---------------- History Functions ----------------
function logAction(text,snapshot){
  const time = timestamp();
  history.push({text,time,snapshot});
  renderHistory();
}

function renderHistory(){
  const container = document.getElementById("historyContainer");
  container.innerHTML = "";
  const total = history.length;

  // newest first
  for(let i=total-1;i>=0;i--){
    const h = history[i];
    const div = document.createElement("div");
    div.className = "historyEntry";
    if(i === total -1) div.classList.add("recent"); // highlight most recent

    // collapse older if not expanded
    if(!historyExpanded && total - i > MAX_HISTORY_DISPLAY) div.classList.add("collapsed");

    div.innerHTML = `<span class="action">${h.text}</span> <span class="date">${h.time}</span>`;
    container.appendChild(div);
  }

  // update toggle button text
  const btn = document.getElementById("toggleHistoryButton");
  btn.innerText = historyExpanded ? "Collapse Older History" : "Show Older History";
}

// toggle collapsed history
function toggleHistory(){
  historyExpanded = !historyExpanded;
  renderHistory();
}

// ---------------- Load Data ----------------
window.onload = function(){
  fetch(WEB_APP_URL)
    .then(res=>res.json())
    .then(res=>{
      data = res;
      originalData = JSON.parse(JSON.stringify(res));
      history = res.History || [];
      renderItems();
      renderHistory();
      updateDisplay();
    })
    .catch(err=>{
      document.body.innerHTML="<h2>Error loading data. Check Web App URL and deployment.</h2>";
      console.error(err);
    });
};

// ---------------- Render Items ----------------
function renderItems(){
  const container = document.getElementById("itemsContainer");
  container.innerHTML = "";
  for(let item in data){
    if(item==="Total Spinned" || item==="History") continue;
    const div = document.createElement("div");
    div.className="card";
    if(data[item].inventory===0) div.classList.add("outOfStock");
    div.id = `card-${safeId(item)}`;
    div.innerHTML=`
      <div class="info"><strong>${item}</strong><br><span id="${safeId(item)}"></span></div>
      <button class="bigButton" onclick="handleClick('${item}')">${item==="Donation"?"+1":"-1"}</button>
    `;
    container.appendChild(div);
  }

  // Undo button
  const undoDiv = document.createElement("div");
  undoDiv.style.textAlign="center";
  undoDiv.style.marginTop="20px";
  undoDiv.innerHTML=`<button class="bigButton" onclick="undo()">Undo Last Action</button>`;
  container.appendChild(undoDiv);
}

// ---------------- Update Display ----------------
function updateDisplay(){
  for(let item in data){
    if(item==="Total Spinned" || item==="History") continue;
    const el = document.getElementById(safeId(item));
    el.innerText = `Inventory: ${data[item].inventory} | Sectors: ${data[item].sectors}`;

    // Highlight out-of-stock
    const cardEl = document.getElementById(`card-${safeId(item)}`);
    if(data[item].inventory===0) cardEl.classList.add("outOfStock");
    else cardEl.classList.remove("outOfStock");
  }
  document.getElementById("totalSpins").innerText = data["Total Spinned"];
}

// ---------------- Handle Click ----------------
function handleClick(item){
  const preSnapshot = JSON.parse(JSON.stringify(data)); // before action

  let actionText = "";
  if(item==="Donation"){
    data[item].inventory++;
    data["Total Spinned"]++;
    actionText = "+1 Donation";
  }else{
    if(data[item].inventory <= 0) return;
    data[item].inventory--;
    data["Total Spinned"]++;
    actionText = `-1 ${item}`;
  }

  // Save user action snapshot
  history.push({text:actionText, preSnapshot: preSnapshot});

  // Redistribution happens after, but not included in undo snapshot
  if(item !== "Donation" && data[item].inventory===0){
    redistributeSectors(item);
  }

  updateDisplay();
  renderHistory();
  sync();
}

function undo(){
  if(history.length===0){ alert("No actions to undo"); return; }

  const lastAction = history.pop();
  data = JSON.parse(JSON.stringify(lastAction.preSnapshot)); // restore pre-action state

  updateDisplay();
  renderHistory();
  sync();
}

function redistributeSectors(outItem){
  let removed = data[outItem].sectors;
  if(removed===0) return;
  data[outItem].sectors=0;
  let remaining = removed;
  let instructions=[];

  if(data["Donation"].sectors < 7 && remaining>0){
    data["Donation"].sectors++;
    instructions.push("Add 1 Donation sector");
    remaining--;
  }

  while(remaining>0){
    let available = Object.keys(data)
      .filter(k=>k!==outItem && k!=="Total Spinned")
      .filter(k=>data[k].inventory>0);
    if(available.length === 0) break;
    available.sort((a,b)=>data[b].inventory - data[a].inventory);
    for(let item of available){
      if(remaining <= 0) break;
      data[item].sectors++;
      instructions.push(`Add 1 ${item} sector`);
      remaining--;
    }
    if(available.length===1 && remaining>0){
      data[available[0]].sectors += remaining;
      instructions.push(`Add ${remaining} ${available[0]} sector(s)`);
      remaining = 0;
    }
  }

  const snapshot = JSON.parse(JSON.stringify(data));
  instructions.forEach(inst => history.push({text:inst})); // redistribution actions not undoable

  let msg = `âš  ${outItem} is OUT OF STOCK.\nRemoved ${removed} sector(s).\nReplace sectors as follows:\n`;
  instructions.forEach(i => msg+="- "+i+"\n");
  alert(msg);
}
</script>

</body>
</html>
